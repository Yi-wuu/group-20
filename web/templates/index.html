<html>
<head>

    <div style = "text-align: center;">dublin bike</div>
    <!-- <link rel=stylesheet type="text/css" href="index.css"> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>


<script

src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAvBNXUTSTxrubQdbSTLWk01GbuAEoq2H0&sensor=false">
</script>

<script>

    var myCenter=new google.maps.LatLng(53.350140, -6.266155);

function initialize() {
    var mapProp = {
        center: new google.maps.LatLng(53.350140, -6.266155),
        zoom: 13,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    };
    var map = new google.maps.Map(document.getElementById("googleMap"), mapProp);

    var marker = new google.maps.Marker({
        position: myCenter,
    });




    function showStationMarkers() {
        let json = $.getJSON("http://127.0.0.1:5000/bikeMix", null, function (obj) {

                var stations = obj.bikeMix;
// var infowindow = new google.maps.InfoWindow();
                // console.log('stations', stations);
                for (var i = 0; i < stations.length; i++) {
                    var lat = stations[i].lat;
                    var lng = stations[i].lng;
        // var infowindow = new google.maps.InfoWindow();

                    var stationsInfo =  '<div class="info_content">' +
        '<p>' + 'Station Number:' + stations[i].number + '</p>' +
        '<p>' + 'Station Name:'+ stations[i].name + '</p>' + '<p>' + 'Total Bike Stands:'+ stations[i].bike_stands + '</p>' +
        'Available Bike Stands:'+ stations[i].available_bike_stands + '</p>' +
        'Available Bikes:'+ stations[i].available_bikes + '</p>' +
                        '</div>';

                    var station_number = stations[i].number;
                    var marker = new google.maps.Marker({
                        position: {
                            lat: lat,
                            lng: lng
                        },
                        map: map,
                        animation:google.maps.Animation.Drop,
                        title: stations[i].name,
                        station_number: stations[i].number

                    });
                    marker.setMap(map);


                    var infowindow  = new google.maps.InfoWindow({
                        content: ""
                    });
                    var pre = false;

            google.maps.event.addListener(marker,'click', (function(marker,stationsInfo,infowindow){
                if(pre){
                    pre.close();
                }
                pre = infowindow;
                var number_id = stations[i].number;
                return function() {
                    pre.setContent(stationsInfo);
                    pre.open(map, marker);
                    showchart(number_id);
                };
            })(marker,stationsInfo,infowindow));
//
//                     google.maps.event.addListener(marker, 'click', (function (marker, i) {
//
//                     var contentString = stationsInfo;
//                     // console.log(contentString);
//                     var number_id = stations[i].number;
//                     infowindow = new google.maps.InfoWindow({
//                     content: contentString
//                     })
//
//                   google.maps.event.addListener(map, "click", function(event) {
//     infowindow.close();
//
// });
//
//                     return function () {
//                     infowindow.open(map, marker);
//                     showchart(number_id);
//                     }
//                     })(marker, i));


                };
        });
function showchart(number_id){

        google.charts.load('current', {
        'packages': ['corechart']
      });

      google.charts.setOnLoadCallback(drawChart);

      function drawChart() {
          var url = 'http://127.0.0.1:5000/dynamic/' + number_id;

     let json = $.getJSON(url, null, function (obj) {
         var chart_info = obj.chart_info;
         var arr = [];
         arr.push(['hour', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday']);
         console.log('cgart_info', chart_info);
         for (var i = 0; i < chart_info.length; i++) {
             var arr1 = [];

            for (var j = 0; j < chart_info[i].length; j++) {
                if (j==0){
                    arr1.push(chart_info[i][j]+"");
                }
                else{
                    arr1.push(chart_info[i][j]);
                }


            }
            console.log('arr1', arr1);
                arr.push(arr1)
        }


        var data = google.visualization.arrayToDataTable(arr);

        var options = {
          title: 'Average bikes in use per hour, per day(based on the last 2 weeks)',

          hAxis: {
            title: 'Hour',
            titleTextStyle: {
              color: '#333'
            }
          },
          vAxis: {
            minValue: 0,
            gridlines: {
              count: 24,
            }
          }
        };

        var chart = new google.visualization.AreaChart(document.getElementById('chart_div'));
        chart.draw(data, options);
      });
      }

    }


    }
    showStationMarkers();
}

google.maps.event.addDomListener(window, 'load', initialize);


function dropdown(){
    let json = $.getJSON("http://127.0.0.1:5000/bikeMix", null, function (obj) {

        var stations = obj.bikeMix;
        var options = "<option value=''>Select</option>";
        for (var i = 0; i < stations.length; i++) {
            var StationName = stations[i].name;
            options += "<option value ='" + StationName + "'>" + StationName + "</option>";


        }
        document.getElementById("dropdown").innerHTML = options


    })
}
dropdown();

function stationInfo(){
    let json = $.getJSON("http://127.0.0.1:5000/bikeMix", null, function (obj) {

    var stations = obj.bikeMix;
    var stationInfo = "<table border = 1 id='theTable'>";
    var chosenStation = document.getElementById("dropdown").value;

    for (var i = 0; i < stations.length; i++) {

        var StationName = stations[i].name;

        if (chosenStation == StationName){

            var available_bikes = stations[i].available_bikes;
            var available_bike_stands = stations[i].available_bike_stands;
            var number = stations[i].number;
            var bike_stands = stations[i].bike_stands;

            stationInfo += "<tr><td>Name</td><td>" + StationName + "</td></tr>";
            stationInfo += "<tr><td>Station number</td><td>" + number + "</td></tr>";
            stationInfo += "<tr><td>Total bike stands</td><td>" + bike_stands + "</td></tr>";
            stationInfo += "<tr><td>Available bike stands</td><td>" + available_bike_stands + "</td></tr>";
            stationInfo += "<tr><td>Available bikes</td><td>" + available_bikes + "</td></tr>";



            stationInfo += "</table>"

    }
}
document.getElementById('stationInfo').innerHTML = stationInfo;

})
}
stationInfo();
function show_weather(){
 let json = $.getJSON("http://127.0.0.1:5000/weather", null, function (data) {

    if ('weather' in data) {

        var weather = data.weather;

        console.log('weather', weather);
        var description = weather[0].description;
        var feels_like = weather[0].feels_like;
        var gust = weather[0].gust;
        display_info = "<table border = 1 id=\"weatherTable\">";

            display_info += "<tr><td>temperature</td><td>" + weather[0].temp + "</td></tr>";
            display_info += "<tr><td>min temperature</td><td>" + weather[0].temp_min + "</td></tr>";
            display_info += "<tr><td>max temperature</td><td>" + weather[0].temp_max + "</td></tr>";
            display_info += "<tr><td>feels like</td><td>" + weather[0].feels_like + "</td></tr>";
            display_info += "<tr><td>description</td><td>" + weather[0].description + "</td></tr>";
            display_info += "<tr><td>pressure</td><td>" + weather[0].pressure + " hpa</td></tr>";
            display_info += "<tr><td>humidity</td><td>" + weather[0].humidity + "%</td></tr>";
            display_info += "<tr><td>sunrise</td><td>" + weather[0].sunrise + "</td></tr>";
            display_info += "<tr><td>sunset</td><td>" + weather[0].sunset + "</td></tr>";





            display_info += "</table>"

            document.getElementById("weather").innerHTML = display_info;
    }

});
}
show_weather();
</script>

</head>

<body>
<h1>Dublin Bike</h1>
<div id="googleMap" style="width:100%;height:500px; "></div>
<div id="chart_div" style="width: 100%; height: 500px;"></div>
<hr>
<h3>Station Info</h3>
<select id="dropdown" required></select>
<input type="button" value="SUBMIT" onclick="return stationInfo();" id="button">
<div id='stationInfo'></div>

<h3>Weather</h3>
<div id="weather" style="width:100%;height:500px; "></div>

</body>
</html>